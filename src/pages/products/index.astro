---
import AdminLayout from "@/layouts/AdminLayout.astro";
---

<AdminLayout title="Produkte">
  <div x-data="productList()">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <input
          type="search"
          placeholder="Produkte suchen..."
          x-model="search"
          @input.debounce.300ms="loadProducts()"
          class="rounded-lg border border-gray-300 px-4 py-2 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
        />
        <select
          x-model="statusFilter"
          @change="loadProducts()"
          class="rounded-lg border border-gray-300 px-4 py-2"
        >
          <option value="">Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="draft">Entwurf</option>
          <option value="archived">Archiviert</option>
        </select>
      </div>
      <a
        href="/products/new"
        class="rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700"
      >
        Neues Produkt
      </a>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-12">
      <div class="h-8 w-8 animate-spin rounded-full border-4 border-primary-600 border-t-transparent"></div>
    </div>

    <!-- Products Table -->
    <div x-show="!loading" class="overflow-hidden rounded-lg bg-white shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Produkt</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">SKU</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Preis</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Bestand</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500">Aktionen</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <template x-for="product in products" :key="product.id">
            <tr class="hover:bg-gray-50">
              <td class="whitespace-nowrap px-6 py-4">
                <div class="flex items-center">
                  <div class="h-10 w-10 flex-shrink-0 rounded bg-gray-200"></div>
                  <div class="ml-4">
                    <div class="font-medium text-gray-900" x-text="product.name"></div>
                    <div class="text-sm text-gray-500" x-text="product.slug"></div>
                  </div>
                </div>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="product.sku || '-'"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900" x-text="formatPrice(product.price)"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm" :class="product.stock < 10 ? 'text-red-600' : 'text-gray-500'" x-text="product.stock"></td>
              <td class="whitespace-nowrap px-6 py-4">
                <span
                  class="inline-flex rounded-full px-2 text-xs font-semibold leading-5"
                  :class="{
                    'bg-green-100 text-green-800': product.status === 'active',
                    'bg-yellow-100 text-yellow-800': product.status === 'draft',
                    'bg-gray-100 text-gray-800': product.status === 'archived'
                  }"
                  x-text="product.status"
                ></span>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                <a :href="`/products/${product.id}`" class="text-primary-600 hover:text-primary-900">Bearbeiten</a>
                <button @click="deleteProduct(product.id)" class="ml-4 text-red-600 hover:text-red-900">Löschen</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3">
        <div class="text-sm text-gray-700">
          Zeige <span x-text="(page - 1) * limit + 1"></span> bis <span x-text="Math.min(page * limit, total)"></span> von <span x-text="total"></span>
        </div>
        <div class="flex gap-2">
          <button
            @click="page--; loadProducts()"
            :disabled="page <= 1"
            class="rounded border px-3 py-1 text-sm disabled:opacity-50"
          >
            Zurück
          </button>
          <button
            @click="page++; loadProducts()"
            :disabled="page * limit >= total"
            class="rounded border px-3 py-1 text-sm disabled:opacity-50"
          >
            Weiter
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function productList() {
      return {
        products: [],
        loading: true,
        search: "",
        statusFilter: "",
        page: 1,
        limit: 20,
        total: 0,

        async init() {
          await this.loadProducts();
        },

        async loadProducts() {
          this.loading = true;
          try {
            const params = new URLSearchParams({
              page: String(this.page),
              limit: String(this.limit),
            });
            if (this.search) params.set("search", this.search);
            if (this.statusFilter) params.set("status", this.statusFilter);

            const API_URL = import.meta.env?.PUBLIC_API_URL || "http://localhost:3000";
            const token = localStorage.getItem("admin_token");
            const response = await fetch(`${API_URL}/trpc/product.list?input=${encodeURIComponent(JSON.stringify({ json: { page: this.page, limit: this.limit, search: this.search || undefined, status: this.statusFilter || undefined } }))}`, {
              headers: token ? { Authorization: `Bearer ${JSON.parse(token)}` } : {},
            });

            if (response.ok) {
              const data = await response.json();
              this.products = data.result?.data?.json?.products || [];
              this.total = data.result?.data?.json?.total || 0;
            }
          } catch (e) {
            console.error("Failed to load products:", e);
          } finally {
            this.loading = false;
          }
        },

        formatPrice(cents: number) {
          return new Intl.NumberFormat("de-DE", { style: "currency", currency: "EUR" }).format(cents / 100);
        },

        async deleteProduct(id: string) {
          if (!confirm("Produkt wirklich löschen?")) return;
          try {
            const API_URL = import.meta.env?.PUBLIC_API_URL || "http://localhost:3000";
            const token = localStorage.getItem("admin_token");
            await fetch(`${API_URL}/trpc/product.delete`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                ...(token ? { Authorization: `Bearer ${JSON.parse(token)}` } : {}),
              },
              body: JSON.stringify({ json: { id } }),
            });
            await this.loadProducts();
          } catch (e) {
            console.error("Failed to delete product:", e);
          }
        },
      };
    }
  </script>
</AdminLayout>
