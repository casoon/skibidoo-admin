---
import AdminLayout from "@/layouts/AdminLayout.astro";
---

<AdminLayout title="Benutzer">
  <div class="space-y-6" x-data="userManagement()">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-900">Benutzer & Rollen</h1>
      <button @click="showAddUser = true" class="rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700">+ Neuer Benutzer</button>
    </div>

    <!-- Users Table -->
    <div class="rounded-lg bg-white shadow">
      <div class="border-b px-6 py-4">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Administratoren</h2>
          <input type="text" x-model="searchQuery" placeholder="Suchen..." class="rounded border-gray-300 text-sm" />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">Benutzer</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">Rolle</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">Letzter Login</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase text-gray-500">2FA</th>
              <th class="px-6 py-3 text-right text-xs font-medium uppercase text-gray-500">Aktionen</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 bg-white">
            <template x-for="user in filteredUsers" :key="user.id">
              <tr>
                <td class="whitespace-nowrap px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary-100 text-primary-700 font-medium" x-text="user.name.charAt(0).toUpperCase()"></div>
                    <div>
                      <div class="font-medium text-gray-900" x-text="user.name"></div>
                      <div class="text-sm text-gray-500" x-text="user.email"></div>
                    </div>
                  </div>
                </td>
                <td class="whitespace-nowrap px-6 py-4">
                  <span class="inline-flex rounded-full px-2 py-1 text-xs font-semibold" :class="getRoleBadgeClass(user.role)" x-text="getRoleLabel(user.role)"></span>
                </td>
                <td class="whitespace-nowrap px-6 py-4">
                  <span class="inline-flex items-center gap-1 text-sm" :class="user.active ? `text-green-600` : `text-gray-400`">
                    <span class="h-2 w-2 rounded-full" :class="user.active ? `bg-green-500` : `bg-gray-300`"></span>
                    <span x-text="user.active ? `Aktiv` : `Inaktiv`"></span>
                  </span>
                </td>
                <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="user.lastLogin || `Nie`"></td>
                <td class="whitespace-nowrap px-6 py-4">
                  <span x-show="user.twoFactorEnabled" class="text-green-600">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                  </span>
                  <span x-show="!user.twoFactorEnabled" class="text-gray-300">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                  </span>
                </td>
                <td class="whitespace-nowrap px-6 py-4 text-right">
                  <div class="flex justify-end gap-2">
                    <button @click="editUser(user)" class="text-primary-600 hover:text-primary-800">Bearbeiten</button>
                    <button @click="deleteUser(user)" class="text-red-600 hover:text-red-800" :disabled="user.role === `owner`" :class="user.role === `owner` && `opacity-50 cursor-not-allowed`">Loeschen</button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Roles Section -->
    <div class="rounded-lg bg-white p-6 shadow">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Rollen & Berechtigungen</h2>
        <button @click="showAddRole = true" class="rounded border border-gray-300 px-3 py-1.5 text-sm hover:bg-gray-50">+ Neue Rolle</button>
      </div>

      <div class="space-y-4">
        <template x-for="role in roles" :key="role.id">
          <div class="rounded-lg border p-4">
            <div class="mb-3 flex items-center justify-between">
              <div>
                <h3 class="font-medium" x-text="role.name"></h3>
                <p class="text-sm text-gray-500" x-text="role.description"></p>
              </div>
              <div class="flex gap-2" x-show="!role.system">
                <button @click="editRole(role)" class="text-sm text-primary-600 hover:text-primary-800">Bearbeiten</button>
                <button @click="deleteRole(role)" class="text-sm text-red-600 hover:text-red-800">Loeschen</button>
              </div>
              <span x-show="role.system" class="text-xs text-gray-400">Systemrolle</span>
            </div>

            <div class="flex flex-wrap gap-2">
              <template x-for="perm in role.permissions" :key="perm">
                <span class="rounded bg-gray-100 px-2 py-1 text-xs text-gray-600" x-text="getPermissionLabel(perm)"></span>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="rounded-lg bg-white p-6 shadow">
      <h2 class="mb-4 text-lg font-semibold">Aktivitaetsprotokoll</h2>
      <div class="space-y-3">
        <template x-for="log in activityLogs" :key="log.id">
          <div class="flex items-start gap-3 text-sm">
            <div class="flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full bg-gray-100 text-gray-600" x-text="log.user.charAt(0)"></div>
            <div class="flex-1">
              <p><span class="font-medium" x-text="log.user"></span> <span x-text="log.action"></span></p>
              <p class="text-gray-500" x-text="log.timestamp"></p>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div x-show="showAddUser || editingUser" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="closeUserModal()">
      <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-xl">
        <h3 class="mb-4 text-lg font-semibold" x-text="editingUser ? `Benutzer bearbeiten` : `Neuer Benutzer`"></h3>

        <div class="space-y-4">
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Name</label>
            <input type="text" x-model="userForm.name" class="w-full rounded border-gray-300 text-sm" />
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">E-Mail</label>
            <input type="email" x-model="userForm.email" class="w-full rounded border-gray-300 text-sm" />
          </div>
          <div x-show="!editingUser">
            <label class="mb-1 block text-sm font-medium text-gray-700">Passwort</label>
            <input type="password" x-model="userForm.password" class="w-full rounded border-gray-300 text-sm" />
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Rolle</label>
            <select x-model="userForm.role" class="w-full rounded border-gray-300 text-sm">
              <template x-for="role in roles" :key="role.id">
                <option :value="role.id" x-text="role.name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="flex items-center gap-2">
              <input type="checkbox" x-model="userForm.active" class="rounded border-gray-300 text-primary-600" />
              <span class="text-sm">Aktiv</span>
            </label>
          </div>
          <div>
            <label class="flex items-center gap-2">
              <input type="checkbox" x-model="userForm.requireTwoFactor" class="rounded border-gray-300 text-primary-600" />
              <span class="text-sm">2FA erforderlich</span>
            </label>
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-3">
          <button @click="closeUserModal()" class="rounded-lg border border-gray-300 px-4 py-2 text-sm hover:bg-gray-50">Abbrechen</button>
          <button @click="saveUser()" class="rounded-lg bg-primary-600 px-4 py-2 text-sm text-white hover:bg-primary-700">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function userManagement() {
      return {
        searchQuery: "",
        showAddUser: false,
        showAddRole: false,
        editingUser: null,
        userForm: { name: "", email: "", password: "", role: "editor", active: true, requireTwoFactor: false },

        users: [
          { id: "1", name: "Max Mustermann", email: "max@example.com", role: "owner", active: true, lastLogin: "29.11.2024, 14:30", twoFactorEnabled: true },
          { id: "2", name: "Anna Schmidt", email: "anna@example.com", role: "admin", active: true, lastLogin: "28.11.2024, 09:15", twoFactorEnabled: true },
          { id: "3", name: "Peter Mueller", email: "peter@example.com", role: "editor", active: true, lastLogin: "27.11.2024, 16:45", twoFactorEnabled: false },
          { id: "4", name: "Lisa Weber", email: "lisa@example.com", role: "viewer", active: false, lastLogin: "15.11.2024, 11:00", twoFactorEnabled: false },
        ],

        roles: [
          { id: "owner", name: "Inhaber", description: "Vollzugriff auf alle Funktionen", system: true, permissions: ["all"] },
          { id: "admin", name: "Administrator", description: "Vollzugriff ausser Inhaberfunktionen", system: true, permissions: ["products", "orders", "customers", "settings", "reports", "users"] },
          { id: "editor", name: "Redakteur", description: "Kann Produkte und Inhalte bearbeiten", system: true, permissions: ["products", "orders.view", "customers.view"] },
          { id: "viewer", name: "Betrachter", description: "Nur Leserechte", system: true, permissions: ["products.view", "orders.view", "customers.view", "reports.view"] },
          { id: "support", name: "Support", description: "Kundenservice-Zugriff", system: false, permissions: ["orders", "customers", "refunds"] },
        ],

        activityLogs: [
          { id: "1", user: "Max Mustermann", action: "hat die Versandeinstellungen geaendert", timestamp: "Heute, 14:32" },
          { id: "2", user: "Anna Schmidt", action: "hat Bestellung #1234 versendet", timestamp: "Heute, 11:15" },
          { id: "3", user: "Peter Mueller", action: "hat Produkt T-ShirtBlau bearbeitet", timestamp: "Gestern, 16:45" },
          { id: "4", user: "Max Mustermann", action: "hat Benutzer LisaWeber deaktiviert", timestamp: "Gestern, 09:30" },
        ],

        get filteredUsers() {
          if (!this.searchQuery) return this.users;
          const q = this.searchQuery.toLowerCase();
          return this.users.filter(u => u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
        },

        getRoleBadgeClass(role) {
          const classes = {
            owner: "bg-purple-100 text-purple-800",
            admin: "bg-red-100 text-red-800",
            editor: "bg-blue-100 text-blue-800",
            viewer: "bg-gray-100 text-gray-800",
            support: "bg-green-100 text-green-800",
          };
          return classes[role] || "bg-gray-100 text-gray-800";
        },

        getRoleLabel(roleId) {
          const role = this.roles.find(r => r.id === roleId);
          return role ? role.name : roleId;
        },

        getPermissionLabel(perm) {
          const labels = {
            all: "Vollzugriff",
            products: "Produkte",
            "products.view": "Produkte (nur lesen)",
            orders: "Bestellungen",
            "orders.view": "Bestellungen (nur lesen)",
            customers: "Kunden",
            "customers.view": "Kunden (nur lesen)",
            settings: "Einstellungen",
            reports: "Berichte",
            "reports.view": "Berichte (nur lesen)",
            users: "Benutzerverwaltung",
            refunds: "Rueckerstattungen",
          };
          return labels[perm] || perm;
        },

        editUser(user) {
          this.editingUser = user;
          this.userForm = { ...user, password: "" };
        },

        deleteUser(user) {
          if (user.role === "owner") return;
          if (confirm("Benutzer " + user.name + " wirklich loeschen?")) {
            this.users = this.users.filter(u => u.id !== user.id);
            Alpine.store("notifications").add("success", "Benutzer geloescht");
          }
        },

        closeUserModal() {
          this.showAddUser = false;
          this.editingUser = null;
          this.userForm = { name: "", email: "", password: "", role: "editor", active: true, requireTwoFactor: false };
        },

        async saveUser() {
          if (this.editingUser) {
            const idx = this.users.findIndex(u => u.id === this.editingUser.id);
            if (idx !== -1) this.users[idx] = { ...this.users[idx], ...this.userForm };
            Alpine.store("notifications").add("success", "Benutzer aktualisiert");
          } else {
            this.users.push({ ...this.userForm, id: crypto.randomUUID(), lastLogin: null, twoFactorEnabled: false });
            Alpine.store("notifications").add("success", "Benutzer erstellt - Einladungs-E-Mail gesendet");
          }
          this.closeUserModal();
        },

        editRole(role) {
          Alpine.store("notifications").add("info", "Rolleneditor noch nicht implementiert");
        },

        deleteRole(role) {
          if (confirm("Rolle " + role.name + " wirklich loeschen?")) {
            this.roles = this.roles.filter(r => r.id !== role.id);
            Alpine.store("notifications").add("success", "Rolle geloescht");
          }
        },
      };
    }
  </script>
</AdminLayout>
