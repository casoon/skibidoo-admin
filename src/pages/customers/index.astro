---
import AdminLayout from "@/layouts/AdminLayout.astro";
---

<AdminLayout title="Kunden">
  <div x-data="customerList()">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <input
          type="search"
          placeholder="Name, E-Mail oder Kundennummer..."
          x-model="search"
          @input.debounce.300ms="loadCustomers()"
          class="w-80 rounded-lg border border-gray-300 px-4 py-2 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
        />
        <select
          x-model="statusFilter"
          @change="loadCustomers()"
          class="rounded-lg border border-gray-300 px-4 py-2"
        >
          <option value="">Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="inactive">Inaktiv</option>
        </select>
      </div>
      <a
        href="/customers/new"
        class="rounded-lg bg-primary-600 px-4 py-2 text-white hover:bg-primary-700"
      >
        Neuer Kunde
      </a>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-12">
      <div class="h-8 w-8 animate-spin rounded-full border-4 border-primary-600 border-t-transparent"></div>
    </div>

    <!-- Customers Table -->
    <div x-show="!loading" class="overflow-hidden rounded-lg bg-white shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Kunde</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Kundennummer</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Gruppe</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Bestellungen</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Umsatz</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Registriert</th>
            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500">Aktionen</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <template x-for="customer in customers" :key="customer.id">
            <tr class="hover:bg-gray-50">
              <td class="whitespace-nowrap px-6 py-4">
                <div class="flex items-center">
                  <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-primary-100 text-primary-600">
                    <span x-text="getInitials(customer)"></span>
                  </div>
                  <div class="ml-4">
                    <div class="font-medium text-gray-900" x-text="`${customer.firstName} ${customer.lastName}`"></div>
                    <div class="text-sm text-gray-500" x-text="customer.email"></div>
                  </div>
                </div>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="customer.customerNumber || '-'"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="customer.groupName || 'Standard'"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="customer.orderCount || 0"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900" x-text="formatPrice(customer.totalSpent || 0)"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="formatDate(customer.createdAt)"></td>
              <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                <a :href="`/customers/${customer.id}`" class="text-primary-600 hover:text-primary-900">Details</a>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3">
        <div class="text-sm text-gray-700">
          Zeige <span x-text="(page - 1) * limit + 1"></span> bis <span x-text="Math.min(page * limit, total)"></span> von <span x-text="total"></span>
        </div>
        <div class="flex gap-2">
          <button @click="page--; loadCustomers()" :disabled="page <= 1" class="rounded border px-3 py-1 text-sm disabled:opacity-50">Zur√ºck</button>
          <button @click="page++; loadCustomers()" :disabled="page * limit >= total" class="rounded border px-3 py-1 text-sm disabled:opacity-50">Weiter</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function customerList() {
      return {
        customers: [],
        loading: true,
        search: "",
        statusFilter: "",
        page: 1,
        limit: 20,
        total: 0,

        async init() {
          await this.loadCustomers();
        },

        async loadCustomers() {
          this.loading = true;
          try {
            const API_URL = import.meta.env?.PUBLIC_API_URL || "http://localhost:3000";
            const token = localStorage.getItem("admin_token");
            const params = {
              page: this.page,
              limit: this.limit,
              ...(this.search && { search: this.search }),
              ...(this.statusFilter && { status: this.statusFilter }),
            };

            const response = await fetch(`${API_URL}/trpc/customer.list?input=${encodeURIComponent(JSON.stringify({ json: params }))}`, {
              headers: token ? { Authorization: `Bearer ${JSON.parse(token)}` } : {},
            });

            if (response.ok) {
              const data = await response.json();
              this.customers = data.result?.data?.json?.customers || [];
              this.total = data.result?.data?.json?.total || 0;
            }
          } catch (e) {
            console.error("Failed to load customers:", e);
          } finally {
            this.loading = false;
          }
        },

        formatPrice(cents) {
          return new Intl.NumberFormat("de-DE", { style: "currency", currency: "EUR" }).format(cents / 100);
        },

        formatDate(dateStr) {
          return new Date(dateStr).toLocaleDateString("de-DE");
        },

        getInitials(customer) {
          return ((customer.firstName?.[0] || "") + (customer.lastName?.[0] || "")).toUpperCase() || "?";
        },
      };
    }
  </script>
</AdminLayout>
