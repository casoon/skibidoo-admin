---
import AdminLayout from "@/layouts/AdminLayout.astro";
---

<AdminLayout title="Bestellungen">
  <div x-data="orderList()">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <input
          type="search"
          placeholder="Bestellnummer oder Kunde..."
          x-model="search"
          @input.debounce.300ms="loadOrders()"
          class="rounded-lg border border-gray-300 px-4 py-2 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"
        />
        <select
          x-model="statusFilter"
          @change="loadOrders()"
          class="rounded-lg border border-gray-300 px-4 py-2"
        >
          <option value="">Alle Status</option>
          <option value="pending">Ausstehend</option>
          <option value="processing">In Bearbeitung</option>
          <option value="shipped">Versendet</option>
          <option value="delivered">Zugestellt</option>
          <option value="cancelled">Storniert</option>
        </select>
        <select
          x-model="paymentFilter"
          @change="loadOrders()"
          class="rounded-lg border border-gray-300 px-4 py-2"
        >
          <option value="">Alle Zahlungen</option>
          <option value="pending">Offen</option>
          <option value="paid">Bezahlt</option>
          <option value="refunded">Erstattet</option>
        </select>
      </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-12">
      <div class="h-8 w-8 animate-spin rounded-full border-4 border-primary-600 border-t-transparent"></div>
    </div>

    <!-- Orders Table -->
    <div x-show="!loading" class="overflow-hidden rounded-lg bg-white shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Bestellung</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Kunde</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Datum</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Summe</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Zahlung</th>
            <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500">Aktionen</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <template x-for="order in orders" :key="order.id">
            <tr class="hover:bg-gray-50">
              <td class="whitespace-nowrap px-6 py-4">
                <div class="font-medium text-gray-900" x-text="'#' + order.orderNumber"></div>
              </td>
              <td class="whitespace-nowrap px-6 py-4">
                <div class="text-sm text-gray-900" x-text="order.customerName || 'Gast'"></div>
                <div class="text-sm text-gray-500" x-text="order.email"></div>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500" x-text="formatDate(order.createdAt)"></td>
              <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-gray-900" x-text="formatPrice(order.totalGross)"></td>
              <td class="whitespace-nowrap px-6 py-4">
                <span
                  class="inline-flex rounded-full px-2 text-xs font-semibold leading-5"
                  :class="getStatusClass(order.status)"
                  x-text="getStatusLabel(order.status)"
                ></span>
              </td>
              <td class="whitespace-nowrap px-6 py-4">
                <span
                  class="inline-flex rounded-full px-2 text-xs font-semibold leading-5"
                  :class="getPaymentClass(order.paymentStatus)"
                  x-text="getPaymentLabel(order.paymentStatus)"
                ></span>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                <a :href="`/orders/${order.id}`" class="text-primary-600 hover:text-primary-900">Details</a>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3">
        <div class="text-sm text-gray-700">
          Zeige <span x-text="(page - 1) * limit + 1"></span> bis <span x-text="Math.min(page * limit, total)"></span> von <span x-text="total"></span>
        </div>
        <div class="flex gap-2">
          <button @click="page--; loadOrders()" :disabled="page <= 1" class="rounded border px-3 py-1 text-sm disabled:opacity-50">Zur√ºck</button>
          <button @click="page++; loadOrders()" :disabled="page * limit >= total" class="rounded border px-3 py-1 text-sm disabled:opacity-50">Weiter</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function orderList() {
      return {
        orders: [],
        loading: true,
        search: "",
        statusFilter: "",
        paymentFilter: "",
        page: 1,
        limit: 20,
        total: 0,

        async init() {
          await this.loadOrders();
        },

        async loadOrders() {
          this.loading = true;
          try {
            const API_URL = import.meta.env?.PUBLIC_API_URL || "http://localhost:3000";
            const token = localStorage.getItem("admin_token");
            const params = {
              page: this.page,
              limit: this.limit,
              ...(this.search && { search: this.search }),
              ...(this.statusFilter && { status: this.statusFilter }),
              ...(this.paymentFilter && { paymentStatus: this.paymentFilter }),
            };

            const response = await fetch(`${API_URL}/trpc/order.list?input=${encodeURIComponent(JSON.stringify({ json: params }))}`, {
              headers: token ? { Authorization: `Bearer ${JSON.parse(token)}` } : {},
            });

            if (response.ok) {
              const data = await response.json();
              this.orders = data.result?.data?.json?.orders || [];
              this.total = data.result?.data?.json?.total || 0;
            }
          } catch (e) {
            console.error("Failed to load orders:", e);
          } finally {
            this.loading = false;
          }
        },

        formatPrice(cents) {
          return new Intl.NumberFormat("de-DE", { style: "currency", currency: "EUR" }).format(cents / 100);
        },

        formatDate(dateStr) {
          return new Date(dateStr).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });
        },

        getStatusClass(status) {
          const classes = {
            pending: "bg-yellow-100 text-yellow-800",
            processing: "bg-blue-100 text-blue-800",
            shipped: "bg-purple-100 text-purple-800",
            delivered: "bg-green-100 text-green-800",
            cancelled: "bg-red-100 text-red-800",
          };
          return classes[status] || "bg-gray-100 text-gray-800";
        },

        getStatusLabel(status) {
          const labels = { pending: "Ausstehend", processing: "In Bearbeitung", shipped: "Versendet", delivered: "Zugestellt", cancelled: "Storniert" };
          return labels[status] || status;
        },

        getPaymentClass(status) {
          const classes = { pending: "bg-yellow-100 text-yellow-800", paid: "bg-green-100 text-green-800", refunded: "bg-gray-100 text-gray-800" };
          return classes[status] || "bg-gray-100 text-gray-800";
        },

        getPaymentLabel(status) {
          const labels = { pending: "Offen", paid: "Bezahlt", refunded: "Erstattet" };
          return labels[status] || status;
        },
      };
    }
  </script>
</AdminLayout>
